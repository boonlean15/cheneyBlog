<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>spring cloud gateway | cheney blog</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="human is animal">
    
    <link rel="preload" href="/cheneyBlog/assets/css/0.styles.f77d735e.css" as="style"><link rel="preload" href="/cheneyBlog/assets/js/app.2a1bc94b.js" as="script"><link rel="preload" href="/cheneyBlog/assets/js/2.74bbeaff.js" as="script"><link rel="preload" href="/cheneyBlog/assets/js/1.893c586b.js" as="script"><link rel="preload" href="/cheneyBlog/assets/js/115.3238d6ad.js" as="script"><link rel="prefetch" href="/cheneyBlog/assets/js/10.6a8c38aa.js"><link rel="prefetch" href="/cheneyBlog/assets/js/100.95e5021c.js"><link rel="prefetch" href="/cheneyBlog/assets/js/101.06202c38.js"><link rel="prefetch" href="/cheneyBlog/assets/js/102.f6b0fe8b.js"><link rel="prefetch" href="/cheneyBlog/assets/js/103.c61e99ca.js"><link rel="prefetch" href="/cheneyBlog/assets/js/104.99642148.js"><link rel="prefetch" href="/cheneyBlog/assets/js/105.2ffa3b1f.js"><link rel="prefetch" href="/cheneyBlog/assets/js/106.51eefa60.js"><link rel="prefetch" href="/cheneyBlog/assets/js/107.dabe6fb6.js"><link rel="prefetch" href="/cheneyBlog/assets/js/108.9be5f1d7.js"><link rel="prefetch" href="/cheneyBlog/assets/js/109.6fefe289.js"><link rel="prefetch" href="/cheneyBlog/assets/js/11.fea60cf3.js"><link rel="prefetch" href="/cheneyBlog/assets/js/110.d31f031f.js"><link rel="prefetch" href="/cheneyBlog/assets/js/111.13279446.js"><link rel="prefetch" href="/cheneyBlog/assets/js/112.31d069b8.js"><link rel="prefetch" href="/cheneyBlog/assets/js/113.6cff2a43.js"><link rel="prefetch" href="/cheneyBlog/assets/js/114.1eba6be8.js"><link rel="prefetch" href="/cheneyBlog/assets/js/116.a9a22106.js"><link rel="prefetch" href="/cheneyBlog/assets/js/117.fa2d4d36.js"><link rel="prefetch" href="/cheneyBlog/assets/js/118.301c5e19.js"><link rel="prefetch" href="/cheneyBlog/assets/js/119.705ed344.js"><link rel="prefetch" href="/cheneyBlog/assets/js/12.56b65f1c.js"><link rel="prefetch" href="/cheneyBlog/assets/js/120.bd50b801.js"><link rel="prefetch" href="/cheneyBlog/assets/js/121.b48f6d49.js"><link rel="prefetch" href="/cheneyBlog/assets/js/13.86734518.js"><link rel="prefetch" href="/cheneyBlog/assets/js/14.95961084.js"><link rel="prefetch" href="/cheneyBlog/assets/js/15.b08f5e79.js"><link rel="prefetch" href="/cheneyBlog/assets/js/16.a1ae088e.js"><link rel="prefetch" href="/cheneyBlog/assets/js/17.aa2b462d.js"><link rel="prefetch" href="/cheneyBlog/assets/js/18.6be81e2e.js"><link rel="prefetch" href="/cheneyBlog/assets/js/19.8ef002e9.js"><link rel="prefetch" href="/cheneyBlog/assets/js/20.2b975910.js"><link rel="prefetch" href="/cheneyBlog/assets/js/21.ba290175.js"><link rel="prefetch" href="/cheneyBlog/assets/js/22.c26c4966.js"><link rel="prefetch" href="/cheneyBlog/assets/js/23.cf3ffada.js"><link rel="prefetch" href="/cheneyBlog/assets/js/24.b96b79d1.js"><link rel="prefetch" href="/cheneyBlog/assets/js/25.b2f6097f.js"><link rel="prefetch" href="/cheneyBlog/assets/js/26.3ed02549.js"><link rel="prefetch" href="/cheneyBlog/assets/js/27.a1654b4e.js"><link rel="prefetch" href="/cheneyBlog/assets/js/28.bf32292c.js"><link rel="prefetch" href="/cheneyBlog/assets/js/29.2aa47805.js"><link rel="prefetch" href="/cheneyBlog/assets/js/3.4dcf44ec.js"><link rel="prefetch" href="/cheneyBlog/assets/js/30.319dc4f2.js"><link rel="prefetch" href="/cheneyBlog/assets/js/31.8f00303a.js"><link rel="prefetch" href="/cheneyBlog/assets/js/32.7596994e.js"><link rel="prefetch" href="/cheneyBlog/assets/js/33.5f609bb9.js"><link rel="prefetch" href="/cheneyBlog/assets/js/34.dc9b8b8c.js"><link rel="prefetch" href="/cheneyBlog/assets/js/35.061afdb0.js"><link rel="prefetch" href="/cheneyBlog/assets/js/36.d11c9e8e.js"><link rel="prefetch" href="/cheneyBlog/assets/js/37.c5066515.js"><link rel="prefetch" href="/cheneyBlog/assets/js/38.d6778771.js"><link rel="prefetch" href="/cheneyBlog/assets/js/39.05994203.js"><link rel="prefetch" href="/cheneyBlog/assets/js/4.f2aa92b5.js"><link rel="prefetch" href="/cheneyBlog/assets/js/40.b8f601e0.js"><link rel="prefetch" href="/cheneyBlog/assets/js/41.957ff061.js"><link rel="prefetch" href="/cheneyBlog/assets/js/42.58b92311.js"><link rel="prefetch" href="/cheneyBlog/assets/js/43.2d130ce6.js"><link rel="prefetch" href="/cheneyBlog/assets/js/44.6d78ab81.js"><link rel="prefetch" href="/cheneyBlog/assets/js/45.25898937.js"><link rel="prefetch" href="/cheneyBlog/assets/js/46.ca07bbf9.js"><link rel="prefetch" href="/cheneyBlog/assets/js/47.8c80545a.js"><link rel="prefetch" href="/cheneyBlog/assets/js/48.b5322896.js"><link rel="prefetch" href="/cheneyBlog/assets/js/49.9368b4fb.js"><link rel="prefetch" href="/cheneyBlog/assets/js/5.7e868145.js"><link rel="prefetch" href="/cheneyBlog/assets/js/50.ea5e2b58.js"><link rel="prefetch" href="/cheneyBlog/assets/js/51.68eb1490.js"><link rel="prefetch" href="/cheneyBlog/assets/js/52.f3948645.js"><link rel="prefetch" href="/cheneyBlog/assets/js/53.6218805a.js"><link rel="prefetch" href="/cheneyBlog/assets/js/54.96cd8581.js"><link rel="prefetch" href="/cheneyBlog/assets/js/55.fdea5d39.js"><link rel="prefetch" href="/cheneyBlog/assets/js/56.97d4b64f.js"><link rel="prefetch" href="/cheneyBlog/assets/js/57.91b248d3.js"><link rel="prefetch" href="/cheneyBlog/assets/js/58.b056e048.js"><link rel="prefetch" href="/cheneyBlog/assets/js/59.680956e8.js"><link rel="prefetch" href="/cheneyBlog/assets/js/6.197d190f.js"><link rel="prefetch" href="/cheneyBlog/assets/js/60.eb17eee3.js"><link rel="prefetch" href="/cheneyBlog/assets/js/61.d45b47d8.js"><link rel="prefetch" href="/cheneyBlog/assets/js/62.f7960757.js"><link rel="prefetch" href="/cheneyBlog/assets/js/63.f447bf98.js"><link rel="prefetch" href="/cheneyBlog/assets/js/64.f4ec515f.js"><link rel="prefetch" href="/cheneyBlog/assets/js/65.2405c942.js"><link rel="prefetch" href="/cheneyBlog/assets/js/66.5bd91fb7.js"><link rel="prefetch" href="/cheneyBlog/assets/js/67.8f12da6a.js"><link rel="prefetch" href="/cheneyBlog/assets/js/68.611bfb1c.js"><link rel="prefetch" href="/cheneyBlog/assets/js/69.43ed7d12.js"><link rel="prefetch" href="/cheneyBlog/assets/js/7.a32ca284.js"><link rel="prefetch" href="/cheneyBlog/assets/js/70.8b00c2ae.js"><link rel="prefetch" href="/cheneyBlog/assets/js/71.dcd77349.js"><link rel="prefetch" href="/cheneyBlog/assets/js/72.7b34136e.js"><link rel="prefetch" href="/cheneyBlog/assets/js/73.ab4ef9bb.js"><link rel="prefetch" href="/cheneyBlog/assets/js/74.e2630224.js"><link rel="prefetch" href="/cheneyBlog/assets/js/75.15f7dcb5.js"><link rel="prefetch" href="/cheneyBlog/assets/js/76.f893ca76.js"><link rel="prefetch" href="/cheneyBlog/assets/js/77.54a2add0.js"><link rel="prefetch" href="/cheneyBlog/assets/js/78.3b264378.js"><link rel="prefetch" href="/cheneyBlog/assets/js/79.66881ae7.js"><link rel="prefetch" href="/cheneyBlog/assets/js/80.2e5615f6.js"><link rel="prefetch" href="/cheneyBlog/assets/js/81.270576ba.js"><link rel="prefetch" href="/cheneyBlog/assets/js/82.02352aa6.js"><link rel="prefetch" href="/cheneyBlog/assets/js/83.54d83062.js"><link rel="prefetch" href="/cheneyBlog/assets/js/84.2e26223b.js"><link rel="prefetch" href="/cheneyBlog/assets/js/85.023319ec.js"><link rel="prefetch" href="/cheneyBlog/assets/js/86.19288d57.js"><link rel="prefetch" href="/cheneyBlog/assets/js/87.55c31ac7.js"><link rel="prefetch" href="/cheneyBlog/assets/js/88.34d079a6.js"><link rel="prefetch" href="/cheneyBlog/assets/js/89.857e35a8.js"><link rel="prefetch" href="/cheneyBlog/assets/js/90.dc99d8c5.js"><link rel="prefetch" href="/cheneyBlog/assets/js/91.734ff8ad.js"><link rel="prefetch" href="/cheneyBlog/assets/js/92.9adf7eb3.js"><link rel="prefetch" href="/cheneyBlog/assets/js/93.4de9a7a4.js"><link rel="prefetch" href="/cheneyBlog/assets/js/94.b481eb28.js"><link rel="prefetch" href="/cheneyBlog/assets/js/95.a0996300.js"><link rel="prefetch" href="/cheneyBlog/assets/js/96.235a4969.js"><link rel="prefetch" href="/cheneyBlog/assets/js/97.a8dc967f.js"><link rel="prefetch" href="/cheneyBlog/assets/js/98.27bc98d8.js"><link rel="prefetch" href="/cheneyBlog/assets/js/99.95e5b063.js"><link rel="prefetch" href="/cheneyBlog/assets/js/vendors~docsearch.d856fa52.js">
    <link rel="stylesheet" href="/cheneyBlog/assets/css/0.styles.f77d735e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/cheneyBlog/" class="home-link router-link-active"><!----> <span class="site-name">cheney blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/cheneyBlog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/cheneyBlog/java/jdkRelationship.html" class="nav-link">
  JAVA
</a></div><div class="nav-item"><a href="http://www.lvyestudy.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/boonlean15" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/cheneyBlog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/cheneyBlog/java/jdkRelationship.html" class="nav-link">
  JAVA
</a></div><div class="nav-item"><a href="http://www.lvyestudy.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/boonlean15" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/cheneyBlog/markdown/" class="sidebar-link">Markdown语法</a></li><li><a href="/cheneyBlog/buildBlog/buildBlog.html" class="sidebar-link">Vuepress构建项目</a></li><li><a href="/cheneyBlog/how-to-learn-english/how-to-learn-english.html" class="sidebar-link">学好英语</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SQL</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JAVA基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>并发理论基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>并发工具类</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>并发设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>并发案例分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他并发模型</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NIO</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/cheneyBlog/rpc/rpc.html" class="sidebar-link">RPC</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Netty in action</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>spring cloud</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/cheneyBlog/springcloud/generics.html" class="sidebar-link">spring cloud 概述</a></li><li><a href="/cheneyBlog/springcloud/eureka.html" class="sidebar-link">Eureka</a></li><li><a href="/cheneyBlog/springcloud/feign.html" class="sidebar-link">Feign</a></li><li><a href="/cheneyBlog/springcloud/ribbon.html" class="sidebar-link">Ribbon</a></li><li><a href="/cheneyBlog/springcloud/config.html" class="sidebar-link">Config</a></li><li><a href="/cheneyBlog/springcloud/auth.html" class="sidebar-link">spring cloud 认证和鉴权</a></li><li><a href="/cheneyBlog/springcloud/gateway.html" aria-current="page" class="active sidebar-link">spring cloud gateway网关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/cheneyBlog/springcloud/gateway.html#spring-cloud-gateway概述" class="sidebar-link">spring cloud gateway概述</a></li><li class="sidebar-sub-header"><a href="/cheneyBlog/springcloud/gateway.html#工作原理" class="sidebar-link">工作原理</a></li><li class="sidebar-sub-header"><a href="/cheneyBlog/springcloud/gateway.html#入门案例" class="sidebar-link">入门案例</a></li><li class="sidebar-sub-header"><a href="/cheneyBlog/springcloud/gateway.html#spring-cloud-gateway-路由断言" class="sidebar-link">spring cloud gateway 路由断言</a></li><li class="sidebar-sub-header"><a href="/cheneyBlog/springcloud/gateway.html#spring-cloud-gateway-内置filter" class="sidebar-link">spring cloud gateway 内置filter</a></li><li class="sidebar-sub-header"><a href="/cheneyBlog/springcloud/gateway.html#spring-cloud-gateway基于服务发现的路由规则" class="sidebar-link">spring cloud gateway基于服务发现的路由规则</a></li><li class="sidebar-sub-header"><a href="/cheneyBlog/springcloud/gateway.html#gateway-filter-和-global-filter" class="sidebar-link">gateway filter 和 global filter</a></li><li class="sidebar-sub-header"><a href="/cheneyBlog/springcloud/gateway.html#gateway实战" class="sidebar-link">Gateway实战</a></li><li class="sidebar-sub-header"><a href="/cheneyBlog/springcloud/gateway.html#gateway权重路由" class="sidebar-link">Gateway权重路由</a></li><li class="sidebar-sub-header"><a href="/cheneyBlog/springcloud/gateway.html#gateway使用https" class="sidebar-link">gateway使用https</a></li><li class="sidebar-sub-header"><a href="/cheneyBlog/springcloud/gateway.html#gateway限流" class="sidebar-link">Gateway限流</a></li><li class="sidebar-sub-header"><a href="/cheneyBlog/springcloud/gateway.html#gateway动态路由" class="sidebar-link">gateway动态路由</a></li><li class="sidebar-sub-header"><a href="/cheneyBlog/springcloud/gateway.html#gateway-源码" class="sidebar-link">Gateway 源码</a></li></ul></li></ul></section></li><li><a href="/cheneyBlog/authentication/authentication.html" class="sidebar-link">认证</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Mybatis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Maven</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CICD</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>AI知识</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>springboot</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="spring-cloud-gateway"><a href="#spring-cloud-gateway" class="header-anchor">#</a> spring cloud gateway</h1> <h2 id="spring-cloud-gateway概述"><a href="#spring-cloud-gateway概述" class="header-anchor">#</a> spring cloud gateway概述</h2> <p><strong>什么是spring cloud gateway</strong></p> <blockquote><p>spring官方开发的网关，旨在为微服务架构提供简单，有效且统一的Api路由管理方式。基于filter还提供了，安全，监控，埋点，限流的功能</p></blockquote> <p><strong>出现原因</strong></p> <blockquote><p>网关提供api全托管服务，辅助企业管理大规模的api，降低管理成本和安全风险。包括：协议适配，协议转发，安全策略，防刷，流量和监控日志等。</p></blockquote> <ul><li>网关的核心是filter和filter chain</li></ul> <p><strong>核心概念</strong></p> <ul><li>路由：网关最基础的部分，路由信息由一个ID，一个目的url，一组断言工厂，一组filter组成。如果断言为真，则说明请求的url和配置的路由匹配</li> <li>断言：java8断言函数。gateway是spring的serverWebExchange，允许匹配request中的所有信息，如请求头和参数等。</li> <li>filter：标准的webfilter，gateway中filter分为两种类型，gateway filter和global filter。</li></ul> <h2 id="工作原理"><a href="#工作原理" class="header-anchor">#</a> 工作原理</h2> <p>client -&gt; httpWebHandlerAdapter -&gt; DispatcherHandler -&gt; RoutePredicateHandlerMapping -&gt; lookupRoute -&gt;
filterWebHandler -&gt; pre Filter -&gt; proxy service -&gt; post Filter</p> <p>gateway client 发起请求 -&gt; httpWebHandlerAdapter (组装网关上下文) -&gt; DispatcherHandler (循环遍历mapping，获取handler)
-&gt;  RoutePredicateHandlerMapping(匹配路由信息，断言是否可用) -&gt; lookupRoute -&gt; filterWebHandler(创建过滤器链，调用过滤器) -&gt;
pre filter -&gt; proxy service -&gt; post filter</p> <h2 id="入门案例"><a href="#入门案例" class="header-anchor">#</a> 入门案例</h2> <p><strong>协议适配和协议转发是gateway最基础的功能</strong></p> <blockquote><p>配置依赖-&gt; 添加入口程序 -&gt; 通过代码或者yml配置 Path路由断言工厂实现url直接转发</p></blockquote> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token comment">#当访问http://localhost:8080/baidu,直接转发到https://www.baidu.com/</span>
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> baidu_route
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//baidu.com<span class="token punctuation">:</span>80/
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> Path=/baidu
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> remoteaddr_route
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//baidu.com
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> RemoteAddr=127.0.0.1
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> between_route
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//xujin.org
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Between
            <span class="token key atrule">args</span><span class="token punctuation">:</span>
              <span class="token key atrule">datetime1</span><span class="token punctuation">:</span> 2018<span class="token punctuation">-</span>03<span class="token punctuation">-</span>15T00<span class="token punctuation">:</span>02<span class="token punctuation">:</span>48.513+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span>
              <span class="token key atrule">datetime2</span><span class="token punctuation">:</span> 2018<span class="token punctuation">-</span>03<span class="token punctuation">-</span>15T02<span class="token punctuation">:</span>02<span class="token punctuation">:</span>48.516+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span>
</code></pre></div><h2 id="spring-cloud-gateway-路由断言"><a href="#spring-cloud-gateway-路由断言" class="header-anchor">#</a> spring cloud gateway 路由断言</h2> <blockquote><p>gateway的路由匹配(routePredicateHandlerMapping)是以spring webflux的handler mapping为基础实现的。gateway也是由很多路由断言工参组成的
。request进来，gateway的路由断言工厂，根据配置的路由规则进行断言匹配。成功则进入下一步，失败则返回错误信息</p></blockquote> <p><strong>After路由断言工厂</strong></p> <ul><li>after route predicate factory 取一个UTC时间格式的时间参数，请求进来的当前时间在配置的UTC时间之后，则匹配成功，否则失败</li></ul> <p><strong>before路由断言工厂</strong></p> <ul><li>before跟after正好相反，判断的是时间是否在配置时间之前，是则路由匹配</li></ul> <p><strong>between路由断言工厂</strong></p> <ul><li>between判断的是时间是否在配置的时间范围内，是则路由匹配</li></ul> <blockquote><p>after、before、between三个路由断言工厂可归为一类，以时间作为断言规则</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SCGatewayApplication</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">customRouteLocator</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//生成比当前时间早一个小时的UTC时间</span>
    <span class="token class-name">ZonedDateTime</span> minusTime <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">minusHours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">atZone</span><span class="token punctuation">(</span><span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">systemDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;after_route&quot;</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>minusTime<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://baidu.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SCGatewayApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 生成UTC时间
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UtcTimeUtil</span> <span class="token punctuation">{</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ZonedDateTime</span> time<span class="token operator">=</span>  <span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;zonedDateTime:&quot;</span><span class="token operator">+</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span>  maxTime<span class="token operator">=</span><span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusHours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token constant">ISO_ZONED_DATE_TIME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;maxTime：&quot;</span><span class="token operator">+</span>maxTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span>  minTime<span class="token operator">=</span><span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">minusHours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token constant">ISO_ZONED_DATE_TIME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;minTime:&quot;</span><span class="token operator">+</span>minTime<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token class-name">DateTimeFormatter</span> formatter <span class="token operator">=</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> str<span class="token operator">=</span>time<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>formatter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p><strong>cookie路由断言工厂</strong></p> <ul><li>断言工厂会取两个参数，cookie名称对应的key和value，请求中携带的cookie和cookie断言工厂配置的一致，则匹配成功</li></ul> <p><strong>header路由断言工厂</strong></p> <ul><li>根据配置的路由header信息进行断言匹配路由</li></ul> <p><strong>Host路由断言工厂</strong></p> <ul><li>根据配置的路由Host信息进行断言匹配路由</li></ul> <p><strong>Method路由断言工厂</strong></p> <ul><li>根据配置的路由Method信息对请求方法是GET或者POST进行断言匹配路由</li></ul> <p><strong>query路由断言工厂</strong></p> <ul><li>根据配置的路由请求参数query进行断言匹配路由</li></ul> <p><strong>RemoteAddr路由断言工厂</strong></p> <ul><li>配置一个ipv4或ipv6网段的字符串或ip，请求的ip地址在网段内或ip相同，则匹配成功</li></ul> <blockquote><p>cookie、header、host，method、query可用归为一类，即与客户端的信息相关，要么是header(cookie)，要么是url里面的信息或方法类型，参数</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringCloudGatewayApplication</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">customRouteLocator</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;header_route&quot;</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;X-Request-Id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;xujin&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8071/test/head&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;cookie_route&quot;</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">&quot;chocolate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ch.p&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8071/test/cookie&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;host_route&quot;</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">host</span><span class="token punctuation">(</span><span class="token string">&quot;**.baidu.com:8080&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://jd.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;method_route&quot;</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://jd.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;query_route&quot;</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;baz&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://baidu.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;remoteaddr_route&quot;</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">remoteAddr</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://baidu.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpringCloudGatewayApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="spring-cloud-gateway-内置filter"><a href="#spring-cloud-gateway-内置filter" class="header-anchor">#</a> spring cloud gateway 内置filter</h2> <blockquote><p>gateway内置了很多路由过滤器，可自己根据实际应用场景定制自己的路由过滤器工厂。路由过滤器允许以某种方式修改进来的http请求和http响应，主要作用于特定的
路由。gateway提供了很多过滤器工厂，有二十多种，主要可归类为，header、parameter、path、status、redirect、hytrix、rateLimiter</p></blockquote> <ul><li>AddRequestHeader过滤器工厂 对匹配上的请求加上header</li> <li>AddRequestParameter 对匹配上的请求加上param</li> <li>RewritePath过滤器 替换zuul的stripPrefix功能，去掉前缀</li> <li>AddResponseHeader 网关返回的响应添加header</li> <li>StripPrefix过滤器 对请求url前缀进行处理 StripPrefixGatewayFilterFactory</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringCloudGatewayApplication</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">testRouteLocator</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;add_request_header_route&quot;</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span>
						r<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filters</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">addRequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;X-Request-Acme&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ValueB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
								<span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8071/test/head&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;add_request_parameter_route&quot;</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span>
                        r<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/addRequestParameter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filters</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">addRequestParameter</span><span class="token punctuation">(</span><span class="token string">&quot;example&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ValueB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8071/test/addRequestParameter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;rewritepath_route&quot;</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span>
                        r<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/foo/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filters</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">rewritePath</span><span class="token punctuation">(</span><span class="token string">&quot;/foo/(?&lt;segment&gt;.*)&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/$\\{segment}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://www.baidu.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//访问http://localhost:8080/foo/cache/sethelp/help.html</span>
      <span class="token comment">// 相当于把前缀去掉，直接访问http://www.baidu.com/cache/sethelp/help.html</span>
        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;add_request_header_route&quot;</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span>
                        r<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filters</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">addResponseHeader</span><span class="token punctuation">(</span><span class="token string">&quot;X-Response-Foo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://www.baidu.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpringCloudGatewayApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>PrefixPathGatewayFilterFactory 用于增加前缀</li></ul> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> baidu_route
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//www.baidu.com
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> Path=/baidu/test/<span class="token important">**</span>
        <span class="token key atrule">filters</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> StripPrefix=2
</code></pre></div><ul><li><strong>Retry过滤器 出现异常或网络抖动，对请求进行重试</strong></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CH1736GatewayApplication</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">retryRouteLocator</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;retry_route&quot;</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/test/retry&quot;</span><span class="token punctuation">)</span>
						<span class="token punctuation">.</span><span class="token function">filters</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span>f<span class="token punctuation">.</span><span class="token function">retry</span><span class="token punctuation">(</span>config <span class="token operator">-&gt;</span> config<span class="token punctuation">.</span><span class="token function">setRetries</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatuses</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
						<span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8071/retry?key=abc&amp;count=2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">CH1736GatewayApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//service的方法测试</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/retry&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testRetryByException</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">AtomicInteger</span> num <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> s <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//对请求或重试次数计数</span>
      <span class="token keyword">int</span> i <span class="token operator">=</span> num<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;重试次数: &quot;</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//计数i小于重试次数2抛出异常，让Spring Cloud Gateway进行重试</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Deal with failure, please try again!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//当重试两次时候，清空计数，返回重试两次成功</span>
      map<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token string">&quot;重试&quot;</span><span class="token operator">+</span>count<span class="token operator">+</span><span class="token string">&quot;次成功！&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>hystrix过滤器 服务降级，友好提示</li></ul> <blockquote><p>例子：当访问的服务不可用，gateway通过hystrix返回了友好提示信息</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FallbackController</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/fallback&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;Spring Cloud Gateway Fallback！&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//服务的方法</span>
  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test/Hystrix&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;isSleep&quot;</span><span class="token punctuation">)</span> <span class="token keyword">boolean</span> isSleep<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;issleep is &quot;</span> <span class="token operator">+</span> isSleep<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//isSleep为true开始睡眠，睡眠时间大于Gateway中的fallback设置的时间</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isSleep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">&quot;No Sleep&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> prefix_route
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8071/test/Hystrix<span class="token punctuation">?</span>isSleep=true
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> Path=/test/Hystrix
        <span class="token key atrule">filters</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Hystrix <span class="token comment"># Hystrix Filter的名称</span>
          <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token comment"># Hystrix配置参数</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> fallbackcmd <span class="token comment">#HystrixCommand的名字</span>
            <span class="token key atrule">fallbackUri</span><span class="token punctuation">:</span> forward<span class="token punctuation">:</span>/fallback <span class="token comment">#fallback对应的uri</span>
</code></pre></div><h2 id="spring-cloud-gateway基于服务发现的路由规则"><a href="#spring-cloud-gateway基于服务发现的路由规则" class="header-anchor">#</a> spring cloud gateway基于服务发现的路由规则</h2> <p><strong>gateway的服务发现路由概述</strong></p> <blockquote><p>gateway考虑从zuul迁移到gateway到兼容性和迁移成本。服务发现路由规则和zuul类似，访问方式：http://http://Gateway_Host:Gateway_Port/大写的serviceId/**</p></blockquote> <p><strong>在不同注册中心下差异如下</strong></p> <ul><li>eureka 大写的serviceId 可通过配置使用小写的serviceId：</li></ul> <blockquote><p>spring.cloud.gateway.discovery.locator.lowerCaseServiceId = true</p></blockquote> <ul><li>zookeeper 小写的serviceId</li> <li>consul 小写的serviceId</li></ul> <p><strong>服务路由规则案例</strong></p> <ul><li>eureak 注册中心 简单的作为注册中心</li> <li>gateway 网关 配置spring.cloud.gateway.discovery.locator.enable=true 配置与服务发现组件一起使用，lowerCaseServiceId小写服务名</li> <li>consumer 消费者 通过feign调用provider的接口</li> <li>provider 服务提供者 提供controller接口供调用</li></ul> <h2 id="gateway-filter-和-global-filter"><a href="#gateway-filter-和-global-filter" class="header-anchor">#</a> gateway filter 和 global filter</h2> <p><strong>gateway filter</strong></p> <blockquote><p>从web filter中复制过来，相当于一个filter过滤器，可对访问的url过滤，进行切面处理</p></blockquote> <p><strong>global filter</strong></p> <blockquote><p>是一个全局filter，作用于所有的路由</p></blockquote> <p><strong>gateway filter 和 global filter的区别</strong></p> <blockquote><p>路由范围：global filter作用于全局，gateway filter作用于单个或一组路由上。
源码：gateway filter继承ShortcutConfigurable，global filter没有任何继承</p></blockquote> <p><strong>自定义Gateway Filter</strong></p> <ol><li>创建自定义的Gateway Filter CustomGatewayFilter 实现自GatewayFilter和Ordered，重写filter()方法</li> <li>把CustomGatewayFilter注入bean实现配置到路由上</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">customRouteLocator</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> builder<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filters</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomGatewayFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8071/customFilter?name=cheney&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;custom_filter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>自定义global filter</strong></p> <ul><li>创建自定义的GolbalFilter AuthSignatureFilter 实现自GolbalFilter和Ordered，重写filter方法。需要添加注解@Component即可，此全局FIlter生效</li></ul> <h2 id="gateway实战"><a href="#gateway实战" class="header-anchor">#</a> Gateway实战</h2> <h2 id="gateway权重路由"><a href="#gateway权重路由" class="header-anchor">#</a> Gateway权重路由</h2> <p>当灰度发布时，比如实现金丝雀测试</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> ch18<span class="token punctuation">-</span>3<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> service1_v1
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8081/v1
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> Path=/test
        <span class="token punctuation">-</span> Weight=service1<span class="token punctuation">,</span> <span class="token number">95</span>
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> service1_v2
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8081/v2
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> Path=/test
        <span class="token punctuation">-</span> Weight=service1<span class="token punctuation">,</span> <span class="token number">5</span>
</code></pre></div><h2 id="gateway使用https"><a href="#gateway使用https" class="header-anchor">#</a> gateway使用https</h2> <blockquote><p>当全站需要https安全时，网关需要支持https。(常规的做法是nginx配置SSL证书)</p></blockquote> <ul><li>只需要将生成的https证书放到gateway的类路径下即可</li></ul> <ol><li>生成ssl证书，并放到gateway项目的resource目录下</li> <li>配置yml文件</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">ssl</span><span class="token punctuation">:</span>
    <span class="token key atrule">key-alias</span><span class="token punctuation">:</span> spring
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">key-password</span><span class="token punctuation">:</span> spring
    <span class="token key atrule">key-store</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>selfsigned.jks
    <span class="token key atrule">key-store-type</span><span class="token punctuation">:</span> JKS
    <span class="token key atrule">key-store-provider</span><span class="token punctuation">:</span> SUN
    <span class="token key atrule">key-store-password</span><span class="token punctuation">:</span> spring
</code></pre></div><ol start="3"><li>LoadBalancerClientFilter的filter方法的loadbalance对http请求进行封装，如gateway进来的是https，则用https封装，是http则用http封装，并且为预留修改的接口。</li> <li>自定义HttpsToHttpFilter，实现自globalFilter，实现把Https转为http</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpsToHttpFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">HTTPS_TO_HTTP_FILTER_ORDER</span> <span class="token operator">=</span> <span class="token number">10099</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">URI</span> originalUri <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ServerHttpRequest<span class="token punctuation">.</span>Builder</span> mutate <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> forwardedUri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>forwardedUri <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> forwardedUri<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;https&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">URI</span> mutatedUri <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URI</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">,</span>
                        originalUri<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        originalUri<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        originalUri<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        originalUri<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        originalUri<span class="token punctuation">.</span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        originalUri<span class="token punctuation">.</span><span class="token function">getFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mutate<span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span>mutatedUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">ServerHttpRequest</span> build <span class="token operator">=</span> mutate<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>build<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 由于LoadBalancerClientFilter的order是10100，
     * 要在LoadBalancerClientFilter执行之前将Https修改为Http，需要设置
     * order为10099
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">HTTPS_TO_HTTP_FILTER_ORDER</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>gateway集成swagger</strong></p> <ol><li>添加依赖</li> <li>编写swaggerProvider，以获取SwaggerResource，因为Swagger不支持WebFlux项目</li> <li>创建Swagger-Resource端点 因为没有在Gateway配置SwaggerConfig，但是运行Swagger-Ui需要依赖一些接口</li> <li>创建SwaggerHeaderFilter，因为Gateway转发的时候，没有把X- Forward-Prefix的header添加到Reques上，需要用这个Filter添加这个Header</li> <li>配置Gateway路由信息</li></ol> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> sc<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
      <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
        <span class="token key atrule">locator</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> sc<span class="token punctuation">-</span>service
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//sc<span class="token punctuation">-</span>service
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> Path=/admin/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> GwSwaggerHeaderFilter
          <span class="token punctuation">-</span> StripPrefix=1
</code></pre></div><ol start="6"><li>然后service工程，则正常的添加依赖，并且配置SwaggerConfig，和Swagger相关Api</li></ol> <h2 id="gateway限流"><a href="#gateway限流" class="header-anchor">#</a> Gateway限流</h2> <h3 id="自定义过滤器实现限流-bucket4j"><a href="#自定义过滤器实现限流-bucket4j" class="header-anchor">#</a> 自定义过滤器实现限流 - Bucket4J</h3> <ol><li>添加依赖<div class="language-yml extra-class"><pre class="language-yml"><code>&lt;dependencies<span class="token punctuation">&gt;</span>
     &lt;<span class="token tag">!--</span> Spring Cloud Gateway的依赖<span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token scalar string">
     &lt;dependency&gt;
         &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
         &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;
     &lt;/dependency&gt;
     &lt;!-- Bucket4j限流依赖--&gt;
     &lt;dependency&gt;
         &lt;groupId&gt;com.github.vladimir-bukhtoyarov&lt;/groupId&gt;
         &lt;artifactId&gt;bucket4j-core&lt;/artifactId&gt;
         &lt;version&gt;4.0.0&lt;/version&gt;
     &lt;/dependency&gt;</span>
 &lt;/dependencies<span class="token punctuation">&gt;</span>
</code></pre></div></li> <li>自定义过滤器对特定资源进行限流</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>bucket4j<span class="token punctuation">.</span></span><span class="token class-name">Bandwidth</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>bucket4j<span class="token punctuation">.</span></span><span class="token class-name">Bucket</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>bucket4j<span class="token punctuation">.</span></span><span class="token class-name">Bucket4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>bucket4j<span class="token punctuation">.</span></span><span class="token class-name">Refill</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">GatewayFilter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">GatewayFilterChain</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Ordered</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpStatus</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">ServerWebExchange</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Mono</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ConcurrentHashMap</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 自定义过滤器进行限流
 * @author xujin
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayRateLimitFilterByIp</span> <span class="token keyword">implements</span> <span class="token class-name">GatewayFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> log <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">GatewayRateLimitFilterByIp</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 单机网关限流用一个ConcurrentHashMap来存储 bucket，
     * 如果是分布式集群限流的话，可以采用 Redis等分布式解决方案
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Bucket</span><span class="token punctuation">&gt;</span></span> <span class="token constant">LOCAL_CACHE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 桶的最大容量，即能装载 Token 的最大数量
     */</span>
    <span class="token keyword">int</span> capacity<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 每次 Token 补充量
     */</span>
    <span class="token keyword">int</span> refillTokens<span class="token punctuation">;</span>
    <span class="token comment">/**
     *补充 Token 的时间间隔
     */</span>
    <span class="token class-name">Duration</span> refillDuration<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">GatewayRateLimitFilterByIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">GatewayRateLimitFilterByIp</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">,</span> <span class="token keyword">int</span> refillTokens<span class="token punctuation">,</span> <span class="token class-name">Duration</span> refillDuration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>capacity <span class="token operator">=</span> capacity<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>refillTokens <span class="token operator">=</span> refillTokens<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>refillDuration <span class="token operator">=</span> refillDuration<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Bucket</span> <span class="token function">createNewBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Refill</span> refill <span class="token operator">=</span> <span class="token class-name">Refill</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>refillTokens<span class="token punctuation">,</span> refillDuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Bandwidth</span> limit <span class="token operator">=</span> <span class="token class-name">Bandwidth</span><span class="token punctuation">.</span><span class="token function">classic</span><span class="token punctuation">(</span>capacity<span class="token punctuation">,</span> refill<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Bucket4j</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLimit</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> ip <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHostAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Bucket</span> bucket <span class="token operator">=</span> <span class="token constant">LOCAL_CACHE</span><span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> k <span class="token operator">-&gt;</span> <span class="token function">createNewBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;IP:{} ,令牌通可用的Token数量:{} &quot;</span> <span class="token punctuation">,</span>ip<span class="token punctuation">,</span>bucket<span class="token punctuation">.</span><span class="token function">getAvailableTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bucket<span class="token punctuation">.</span><span class="token function">tryConsume</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
           <span class="token comment">//当可用的令牌书为0是，进行限流返回429状态码</span>
            exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">TOO_MANY_REQUESTS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>java流式api的方式配置路由规则</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayApplication</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">customerRouteLocator</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/test/rateLimit&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">filters</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GatewayRateLimitFilterByIp</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8000/hello/rateLimit&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;rateLimit_route&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">GatewayApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="gateway内置工厂过滤器实现限流-requestratelimitergatewayfilterfactory"><a href="#gateway内置工厂过滤器实现限流-requestratelimitergatewayfilterfactory" class="header-anchor">#</a> Gateway内置工厂过滤器实现限流 RequestRateLimiterGatewayFilterFactory</h3> <p>使用名为request_rate_limiter.lua lua脚本实现限流</p> <ol><li>添加依赖</li></ol> <div class="language-yml extra-class"><pre class="language-yml"><code>&lt;dependencies<span class="token punctuation">&gt;</span>
    &lt;<span class="token tag">!--</span> Spring Cloud Gateway的依赖<span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token scalar string">
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;
    &lt;/dependency&gt;</span>

    &lt;dependency<span class="token punctuation">&gt;</span>
        &lt;groupId<span class="token punctuation">&gt;</span>org.springframework.boot&lt;/groupId<span class="token punctuation">&gt;</span>
        &lt;artifactId<span class="token punctuation">&gt;</span>spring<span class="token punctuation">-</span>boot<span class="token punctuation">-</span>starter<span class="token punctuation">-</span>data<span class="token punctuation">-</span>redis<span class="token punctuation">-</span>reactive&lt;/artifactId<span class="token punctuation">&gt;</span>
    &lt;/dependency<span class="token punctuation">&gt;</span>
&lt;/dependencies<span class="token punctuation">&gt;</span>
</code></pre></div><ol start="2"><li>gateway相关限流配置</li></ol> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> ch18<span class="token punctuation">-</span>6<span class="token punctuation">-</span>1<span class="token punctuation">-</span>gateway
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> rateLimit_route
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8000/hello/rateLimit
          <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token number">0</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/test/rateLimit
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token comment">#filter名称必须是RequestRateLimiter</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RequestRateLimiter
              <span class="token key atrule">args</span><span class="token punctuation">:</span>
                <span class="token comment">#使用SpEL按名称引用bean</span>
                <span class="token key atrule">key-resolver</span><span class="token punctuation">:</span> <span class="token string">&quot;#{@remoteAddrKeyResolver}&quot;</span>
                <span class="token comment">#允许用户每秒处理多少个请求</span>
                <span class="token key atrule">redis-rate-limiter.replenishRate</span><span class="token punctuation">:</span> <span class="token number">1</span>
                <span class="token comment">#令牌桶的容量，允许在一秒钟内完成的最大请求数</span>
                <span class="token key atrule">redis-rate-limiter.burstCapacity</span><span class="token punctuation">:</span> <span class="token number">5</span>
</code></pre></div><ol start="3"><li>编写key-resolver对应的remoteAddrKeyResolver</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter<span class="token punctuation">.</span>ratelimit<span class="token punctuation">.</span></span><span class="token class-name">KeyResolver</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">ServerWebExchange</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Mono</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RemoteAddrKeyResolver</span> <span class="token keyword">implements</span> <span class="token class-name">KeyResolver</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BEAN_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;remoteAddrKeyResolver&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHostAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>key对应的解析器配置加载到spring容器</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayApplication</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token class-name">RemoteAddrKeyResolver</span><span class="token punctuation">.</span><span class="token constant">BEAN_NAME</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RemoteAddrKeyResolver</span> <span class="token function">remoteAddrKeyResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RemoteAddrKeyResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">GatewayApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="基于cpu使用率进行限流"><a href="#基于cpu使用率进行限流" class="header-anchor">#</a> 基于CPU使用率进行限流</h3> <ol><li>添加依赖</li></ol> <div class="language-yml extra-class"><pre class="language-yml"><code>&lt;dependencies<span class="token punctuation">&gt;</span>
    &lt;<span class="token tag">!--</span> Spring Cloud Gateway的依赖<span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token scalar string">
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
    &lt;/dependency&gt;</span>
&lt;/dependencies<span class="token punctuation">&gt;</span>
</code></pre></div><ol start="2"><li>自定义过滤器并开启基于CPU使用情况的限流</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 根据CPU的使用情况限流
 * @author: xujin
 **/</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayRateLimitFilterByCpu</span> <span class="token keyword">implements</span> <span class="token class-name">GatewayFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> log <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">GatewayRateLimitFilterByCpu</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MetricsEndpoint</span> metricsEndpoint<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">METRIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;system.cpu.usage&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> <span class="token constant">MAX_USAGE</span> <span class="token operator">=</span> <span class="token number">0.50D</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取网关所在机器的CPU使用情况</span>
        <span class="token class-name">Double</span> systemCpuUsage <span class="token operator">=</span> metricsEndpoint<span class="token punctuation">.</span><span class="token function">metric</span><span class="token punctuation">(</span><span class="token constant">METRIC_NAME</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getMeasurements</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">nonNull</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">MetricsEndpoint<span class="token punctuation">.</span>Sample</span><span class="token operator">::</span><span class="token function">getValue</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token operator">::</span><span class="token function">isFinite</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token number">0.0D</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> isOpenRateLimit <span class="token operator">=</span> systemCpuUsage <span class="token operator">&gt;</span><span class="token constant">MAX_USAGE</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;system.cpu.usage: {}, isOpenRateLimit:{} &quot;</span><span class="token punctuation">,</span>systemCpuUsage <span class="token punctuation">,</span> isOpenRateLimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isOpenRateLimit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//当CPU的使用超过设置的最大阀值开启限流</span>
            exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">TOO_MANY_REQUESTS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>java流式api配置作用于某个路由</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayApplication</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">GatewayRateLimitFilterByCpu</span> gatewayRateLimitFilterByCpu<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">customerRouteLocator</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/test/rateLimit&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">filters</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>gatewayRateLimitFilterByCpu<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8000/hello/rateLimit&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;rateLimit_route&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">GatewayApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="gateway动态路由"><a href="#gateway动态路由" class="header-anchor">#</a> gateway动态路由</h2> <ul><li>单机版动态路由
<ol><li>根据springcloud gateway的路由模型定义数据传输模型，创建GatewayFilterDefinition、GatewayPredicateDefinition、GatewayRouteDefinition
<blockquote><p>主要属性，filter和predicate是name和规则args，route是id，uri，order和filter、predicate的集合，即路由断言集合配置、路由过滤器集合配置</p></blockquote></li> <li>编写动态路由实现类，实现自ApplicationEventPublisherWare接口，注入RouteDefinitionWriter和设置publisher
<blockquote><p>添加，删除，更新的方法，通过RouteDefinitionWriter添加、更新、删除。添加和更新比删除多了个publisher.publish发布订阅</p></blockquote></li> <li>添加对应的RestController提供接口，供调用</li></ol></li> <li>集群版动态路由
<blockquote><p>RouteDefinitionWriter的实现类是InMemoryRouteDefinitionRepository，RouteDefinitionRepository继承了RouteDefinitionWriter。
可以通过两种方式实现集群下动态路由：RouteDefinitionWriter和RouteDefinitionRepository。
<strong>推荐实现RouteDefinitionRepository接口，从数据库或者配置中心获取路由进行动态配置</strong></p></blockquote> <ol><li>示例：通过nacos配置中心获取路由，然后动态配置。这里是实现自ApplicationRunner，在项目启动时进行了路由配置</li></ol></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NacosGatewayConfigListener</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationRunner</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DynamicRouteServiceImpl</span> dynamicRouteServiceImpl<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> configName <span class="token operator">=</span> <span class="token string">&quot;gateway-config.yml&quot;</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">NacosConfigManager</span> nacosConfigManager<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ApplicationArguments</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//添加信息到路由</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;准备添加路由------------》&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ConfigService</span> configService <span class="token operator">=</span> nacosConfigManager<span class="token punctuation">.</span><span class="token function">getConfigService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> nacosGroup <span class="token operator">=</span> nacosConfigManager<span class="token punctuation">.</span><span class="token function">getNacosConfigProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> config <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span>configName<span class="token punctuation">,</span> nacosGroup<span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GatewayRouteDefinition</span><span class="token punctuation">&gt;</span></span>  arr <span class="token operator">=</span> <span class="token class-name">JSONArray</span><span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token class-name">GatewayRouteDefinition</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GatewayRouteDefinition</span><span class="token punctuation">&gt;</span></span>  arrUpdate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">GatewayRouteDefinition</span> item <span class="token operator">:</span> arr<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">RouteDefinition</span> route <span class="token operator">=</span> <span class="token function">assembleRouteDefinition</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
                dynamicRouteServiceImpl<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>
                item<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                arrUpdate<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        dynamicRouteServiceImpl<span class="token punctuation">.</span><span class="token function">refreshRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        configService<span class="token punctuation">.</span><span class="token function">publishConfig</span><span class="token punctuation">(</span>configName<span class="token punctuation">,</span> nacosGroup<span class="token punctuation">,</span><span class="token class-name">JSONArray</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>arrUpdate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;添加路由完毕-------------》&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//注册监听</span>
        configService<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>configName<span class="token punctuation">,</span> nacosGroup<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveConfigInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> configInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GatewayRouteDefinition</span><span class="token punctuation">&gt;</span></span>  arr <span class="token operator">=</span> <span class="token class-name">JSONArray</span><span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>configInfo<span class="token punctuation">,</span> <span class="token class-name">GatewayRouteDefinition</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Boolean</span> isUpate <span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GatewayRouteDefinition</span><span class="token punctuation">&gt;</span></span>  arrUpdate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">GatewayRouteDefinition</span> item <span class="token operator">:</span> arr<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token comment">//新增</span>
                        <span class="token class-name">RouteDefinition</span> route <span class="token operator">=</span> <span class="token function">assembleRouteDefinition</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        dynamicRouteServiceImpl<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        item<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        isUpate <span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token comment">//修改</span>
                        <span class="token class-name">RouteDefinition</span> route <span class="token operator">=</span> <span class="token function">assembleRouteDefinition</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        dynamicRouteServiceImpl<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        item<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        isUpate <span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token comment">//删除</span>
                        dynamicRouteServiceImpl<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        isUpate <span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        arrUpdate<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>isUpate<span class="token punctuation">)</span><span class="token punctuation">{</span>
                        dynamicRouteServiceImpl<span class="token punctuation">.</span><span class="token function">refreshRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        configService<span class="token punctuation">.</span><span class="token function">publishConfig</span><span class="token punctuation">(</span>configName<span class="token punctuation">,</span> nacosGroup<span class="token punctuation">,</span><span class="token class-name">JSONArray</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>arrUpdate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NacosException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">getExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="gateway-源码"><a href="#gateway-源码" class="header-anchor">#</a> Gateway 源码</h2> <h3 id="gateway的处理流程"><a href="#gateway的处理流程" class="header-anchor">#</a> Gateway的处理流程</h3> <img width="800" src="https://boonlean15.github.io/cheneyBlog/images/springcloud/gateway-process.jpg" alt="jpg">
* 2.0版本 流程见图
  &gt; HttpWebHandlerAdapter -&gt; DispatcherHandler -&gt; RoutePredicateHandlerMapping -&gt; FilteringWebHandler
  * HttpWebHandlerAdapter： 组装网关上下文
  * DispatcherHandler： 分发处理器，分发请求到对应的处理器
  * RoutePredicateHandlerMapping： 路由断言处理器，路由的查找，返回对应的WebHandler
  * FilteringWebHandler：创建过滤器链，调用filter处理请求
<ul><li>4.0版本 流程
<blockquote><p>Gateway HandlerMapping -&gt; Gateway Web Handler -&gt; FilteringWebHandler</p></blockquote> <ul><li>GatewayHandlerMapping: 路由断言，路由查找，返回对应的WebHandler</li> <li>GatewayWebHandler: 创建过滤器链，调用filter处理请求</li></ul></li></ul> <h3 id="gateway中的serverwebexchange分析"><a href="#gateway中的serverwebexchange分析" class="header-anchor">#</a> Gateway中的ServerWebExchange分析</h3> <blockquote><p>zuul或Gateway或自研网关中间件，都会对request和response进行组装，转换为网关运行的上下文。Gateway的网关上下文是ServerWebExchange。
遇到问题无法解决时，了解Gateway执行的生命周期相当重要，特别是了解从哪个入口开始处理。</p></blockquote> <ul><li>入口HttpServerRequest和HttpServerResponse转换
<blockquote><p>Gateway的请求入口在ReactorHttpHandlerAdapter#apply方法中，把接收到的HttpServerRequest和HttpServerResponse包装转换为
ReactorServerHttpRequest和ReactorServerHttpResponse</p></blockquote></li> <li>构建Gateway的上下文ServerWebExchange
<blockquote><p>在HttpWebHandlerAdapter中#Handle方法，通过creatExchange方法将ServerHttpRequest和ServerHttpResponse构建成网关上下文
ServerWebExchange。WebHandlerDecorator的getDelegate方法通过委托的方式获取一系列需要处理的WebHandler。</p></blockquote></li></ul> <h3 id="dispatcherhandler源码分析"><a href="#dispatcherhandler源码分析" class="header-anchor">#</a> DispatcherHandler源码分析</h3> <blockquote><p>DispatcherHandler实现了WebHandler和ApplicationContextAware接口，http请求的中央分发处理器。把请求分发给已经注册的处理器程序。</p></blockquote> <ol><li>校验HandlerMapping</li> <li>遍历Mapping获取Mapping对应的Handler(找到gateway对应的RoutePredicateHandlerMapping)，
并通过RoutePredicateHandlerMapping获取Handler(FilteringWebHandler)</li> <li>通过Handler对应的HandlerAdapter对Handler进行调用(Gateway使用SimpleHandlerAdapter)，即FilteringWebHandler
和SimpleHandlerAdapter对应</li></ol> <h3 id="routepredicatehandlermapping源码分析"><a href="#routepredicatehandlermapping源码分析" class="header-anchor">#</a> RoutePredicateHandlerMapping源码分析</h3> <ol><li>执行顺序是先通过路由定位器获取全部路由</li> <li>然后通过路由断言过滤掉不符合的路由信息</li> <li>之后将路由信息设置到网关上下文中</li> <li>最后返回Gateway的WebHandler， 即FilteringWebHandler</li></ol> <blockquote><p>GatewayWebFluxEndpoint提供HTTP api，不需要经过网关，是通过RequestMappingHandlerMapping进行请求匹配处理，它的执行顺序在
RoutePredicateHandlerMapping之前执行，所以设置RoutePredicateHandlerMapping的order为0.</p></blockquote> <h3 id="filteringwebhandler源码分析"><a href="#filteringwebhandler源码分析" class="header-anchor">#</a> FilteringWebHandler源码分析</h3> <ol><li>构建一个包含全局过滤器的集合</li> <li>获取上下文中的路由信息，将路由信息里面的过滤器添加到集合中</li> <li>对过滤器进行排序</li> <li>通过过滤器集合组装Filter链并调用Gateway的默认Filter链</li> <li>通过过滤器处理请求并转发到代理服务中</li></ol> <h3 id="执行filter源码分析"><a href="#执行filter源码分析" class="header-anchor">#</a> 执行Filter源码分析</h3> <ol><li>执行进去Filter链，在FilteringWebHandler的最后，通过过滤器处理请求并转发到代理服务中。进入了filter方法</li> <li>执行filter链，通过点击在FilteringWebHandler的最后的filter方法，查看执行filter链逻辑</li> <li>GatewayFilter委托给GlobalFilter执行，FilteringWebHandler#GatewayFitlerAdapter的代码中可看到，
GatewayFilter交给了GlobalFilter去执行</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/cheneyBlog/springcloud/auth.html" class="prev">
        spring cloud 认证和鉴权
      </a></span> <span class="next"><a href="/cheneyBlog/authentication/authentication.html">
        认证
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/cheneyBlog/assets/js/app.2a1bc94b.js" defer></script><script src="/cheneyBlog/assets/js/2.74bbeaff.js" defer></script><script src="/cheneyBlog/assets/js/1.893c586b.js" defer></script><script src="/cheneyBlog/assets/js/115.3238d6ad.js" defer></script>
  </body>
</html>
